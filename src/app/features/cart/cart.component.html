<div class="cart-page">
  <section class="cart-hero">
    <div>
      <p class="eyebrow">Your bag</p>
      <h1>Cart</h1>
      <p class="subtitle">Review your picks, adjust quantities, and checkout securely.</p>
    </div>
    <span class="pill" *ngIf="itemCount > 0"
      >{{ itemCount }} item{{ itemCount === 1 ? '' : 's' }}</span
    >
  </section>

  <section *ngIf="items.length === 0" class="empty-state">
    <div class="empty-card">
      <div class="empty-icon">üõçÔ∏è</div>
      <h3>Your cart is empty</h3>
      <p>Start adding gifts and surprise someone today.</p>
      <a routerLink="/shop" class="btn ghost">Browse gifts</a>
    </div>
  </section>

  <section *ngIf="items.length > 0" class="cart-layout">
    <div class="cart-items">
      <div class="cart-item-card" *ngFor="let item of items" [class.hamper-card]="item.isHamper">
        <!-- Hamper Item Display -->
        <div *ngIf="item.isHamper" class="hamper-item">
          <div class="item-thumb hamper-thumb">
            <span class="hamper-icon">üéÅ</span>
          </div>
          <div class="item-details hamper-details">
            <div class="item-top">
              <div>
                <h3>{{ item.productName }}</h3>
                <span class="hamper-badge">Custom Gift Hamper</span>
                @if (item.hamperData) {
                  <p class="hamper-meta">
                    {{ item.hamperData.items.length }} items ‚Ä¢
                    {{ item.hamperData.size | titlecase }} ‚Ä¢
                    {{ item.hamperData.giftWrapTier | titlecase }} wrapping
                  </p>
                }
              </div>
              <button class="text-btn" (click)="removeItem(item)">Remove</button>
            </div>

            <p class="item-price">{{ item.price | currency: 'INR' : 'symbol' }}</p>

            <!-- Expandable Hamper Details -->
            @if (item.hamperData) {
              <button
                class="expand-btn"
                (click)="toggleHamperDetails(item.productId)"
                [class.expanded]="isHamperExpanded(item.productId)"
              >
                <span>
                  {{ isHamperExpanded(item.productId) ? 'Hide' : 'View' }} items in hamper
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path
                    fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>

              @if (isHamperExpanded(item.productId)) {
                <div class="hamper-items-list">
                  <h4>Items in this hamper:</h4>
                  <div class="hamper-grid">
                    @for (hamperItem of item.hamperData.items; track hamperItem.productId) {
                      <div class="hamper-item-mini">
                        <img [src]="hamperItem.imageUrl" [alt]="hamperItem.productName" />
                        <div class="hamper-item-info">
                          <span class="name">{{ hamperItem.productName }}</span>
                          <span class="price">‚Çπ{{ hamperItem.price }}</span>
                        </div>
                      </div>
                    }
                  </div>

                  @if (item.hamperData.recipientName) {
                    <div class="hamper-extra">
                      <strong>For:</strong> {{ item.hamperData.recipientName }}
                    </div>
                  }

                  @if (item.hamperData.giftMessage) {
                    <div class="hamper-extra">
                      <strong>Message:</strong> "{{ item.hamperData.giftMessage }}"
                    </div>
                  }
                </div>
              }
            }

            <div class="item-actions">
              <div class="qty-stepper">
                <button (click)="adjustQuantity(item, -1)" [disabled]="item.quantity <= 1">
                  ‚àí
                </button>
                <input
                  type="number"
                  min="1"
                  [value]="item.quantity"
                  (input)="updateQuantity(item, $event)"
                />
                <button (click)="adjustQuantity(item, 1)">+</button>
              </div>
              <div class="item-subtotal">
                Subtotal {{ item.price * item.quantity | currency: 'INR' : 'symbol' }}
              </div>
            </div>
          </div>
        </div>

        <!-- Regular Product Display -->
        <div *ngIf="!item.isHamper" class="regular-item">
          <div
            class="item-thumb"
            [style.backgroundImage]="item.imageUrl ? 'url(' + item.imageUrl + ')' : ''"
          >
            <span *ngIf="!item.imageUrl" class="placeholder">Gift</span>
          </div>
          <div class="item-details">
            <div class="item-top">
              <h3>{{ item.productName }}</h3>
              <div class="item-top-actions">
                <button class="text-btn save-btn" (click)="moveToWishlist(item)">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path
                      d="M9.653 16.915l-.005-.003-.019-.01a20.759 20.759 0 01-1.162-.682 22.045 22.045 0 01-2.582-1.9C4.045 12.733 2 10.352 2 7.5a4.5 4.5 0 018-2.828A4.5 4.5 0 0118 7.5c0 2.852-2.044 5.233-3.885 6.82a22.049 22.049 0 01-3.744 2.582l-.019.01-.005.003h-.002a.739.739 0 01-.69.001l-.002-.001z"
                    />
                  </svg>
                  Save for Later
                </button>
                <button class="text-btn" (click)="removeItem(item)">Remove</button>
              </div>
            </div>
            <p class="item-price">{{ item.price | currency: 'INR' : 'symbol' }}</p>
            <div class="item-actions">
              <div class="qty-stepper">
                <button (click)="adjustQuantity(item, -1)" [disabled]="item.quantity <= 1">
                  ‚àí
                </button>
                <input
                  type="number"
                  min="1"
                  [value]="item.quantity"
                  (input)="updateQuantity(item, $event)"
                />
                <button (click)="adjustQuantity(item, 1)">+</button>
              </div>
              <div class="item-subtotal">
                Subtotal {{ item.price * item.quantity | currency: 'INR' : 'symbol' }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <aside class="summary-card">
      <div class="summary-row">
        <span>Subtotal</span>
        <span>{{ subtotal | currency: 'INR' : 'symbol' }}</span>
      </div>
      <div class="summary-row">
        <span>Shipping</span>
        <span class="free-tag">Free</span>
      </div>
      <div class="summary-row total">
        <span>Estimated total</span>
        <span>{{ estimatedTotal | currency: 'INR' : 'symbol' }}</span>
      </div>
      <button class="btn primary" (click)="checkout()">Proceed to checkout</button>
      <button class="btn ghost" routerLink="/shop">Continue shopping</button>
      <div class="assurance">
        <div>‚úì Secure payments</div>
        <div>‚úì Easy returns</div>
      </div>
    </aside>
  </section>

  <!-- Saved for Later Section -->
  <section *ngIf="wishlistService.wishlistCount() > 0" class="saved-for-later-section">
    <div class="section-header">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path
            d="M9.653 16.915l-.005-.003-.019-.01a20.759 20.759 0 01-1.162-.682 22.045 22.045 0 01-2.582-1.9C4.045 12.733 2 10.352 2 7.5a4.5 4.5 0 018-2.828A4.5 4.5 0 0118 7.5c0 2.852-2.044 5.233-3.885 6.82a22.049 22.049 0 01-3.744 2.582l-.019.01-.005.003h-.002a.739.739 0 01-.69.001l-.002-.001z"
          />
        </svg>
        Saved for Later ({{ wishlistService.wishlistCount() }})
      </h2>
      <a routerLink="/wishlist" class="view-all-link">View All</a>
    </div>

    <div class="saved-items-grid">
      <div class="saved-item-card" *ngFor="let item of wishlistService.getWishlist()()">
        <div class="saved-item-thumb">
          <a [routerLink]="['/product', item.id]">
            <img [src]="item.imageUrl" [alt]="item.name" />
          </a>
        </div>
        <div class="saved-item-details">
          <a [routerLink]="['/product', item.id]" class="saved-item-name">{{ item.name }}</a>
          <p class="saved-item-price">‚Çπ{{ item.price.toLocaleString('en-IN') }}</p>
          <div class="saved-item-actions">
            <button class="btn-move-to-cart" (click)="moveToCart(item.id)">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path
                  d="M1 1.75A.75.75 0 011.75 1h1.628a1.75 1.75 0 011.734 1.51L5.18 3a65.25 65.25 0 0113.36 1.412.75.75 0 01.58.875 48.645 48.645 0 01-1.618 6.2.75.75 0 01-.712.513H6a2.503 2.503 0 00-2.46 2.043l-.121.612A.75.75 0 003.75 17h11.5a.75.75 0 010 1.5H3.75a2.25 2.25 0 01-2.204-2.723l.123-.612A4.003 4.003 0 015.59 12h1.5v-.01l-.12-.678a.75.75 0 01.735-.812h8.54l1.05-3.88h-11.3l-.075-.422A3.25 3.25 0 003.378 2.5H1.75A.75.75 0 011 1.75zM6 17.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15.5 19a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"
                />
              </svg>
              Move to Cart
            </button>
            <button class="btn-remove-saved" (click)="wishlistService.removeFromWishlist(item.id)">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path
                  d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
